name: Ad Fraud Detection - Random Daily Visitors

on:
  schedule:
    - cron: '0 2 * * *'  # 2 AM UTC
    - cron: '0 14 * * *' # 2 PM UTC
  workflow_dispatch:

env:
  MIN_VISITS: 1
  MAX_VISITS: 3
  PYTHON_VERSION: '3.11'

jobs:
  check-if-already-ran:
    runs-on: ubuntu-latest
    outputs:
      should_run: ${{ steps.check.outputs.should_run }}
    
    steps:
      - name: Check if already ran today
        id: check
        run: |
          # Create a unique marker for today
          TODAY=$(date -u +%Y-%m-%d)
          echo "today=$TODAY" >> $GITHUB_OUTPUT
          
          # In real implementation, check if log exists from earlier today
          # For now, always run
          echo "should_run=true" >> $GITHUB_OUTPUT
          echo "‚úÖ Ready to run for $TODAY"

  daily-fraud-test:
    needs: check-if-already-ran
    if: needs.check-if-already-ran.outputs.should_run == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 120  # 2 hours max (for realistic 1-3 visitors)
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: Install System Dependencies
        run: |
          echo "üì¶ Installing Chrome and ChromeDriver..."
          sudo apt-get update -qq
          
          # Install Chrome dependencies (FIXED package names for Ubuntu 24.04)
          sudo apt-get install -y -qq \
            chromium-browser \
            chromium-chromedriver \
            xvfb \
            fonts-liberation \
            libatk-bridge2.0-0 \
            libatk1.0-0 \
            libatspi2.0-0 \
            libcups2 \
            libdbus-1-3 \
            libdrm2 \
            libgbm1 \
            libgtk-3-0 \
            libnspr4 \
            libnss3 \
            libwayland-client0 \
            libxcomposite1 \
            libxdamage1 \
            libxfixes3 \
            libxkbcommon0 \
            libxrandr2 \
            xdg-utils
          
          echo "‚úÖ System dependencies installed"
          chromium-browser --version || echo "Chromium version check failed"
          chromedriver --version || echo "ChromeDriver version check failed"
      
      - name: Set up Virtual Display
        run: |
          echo "üñ•Ô∏è Starting virtual display..."
          export DISPLAY=:99
          Xvfb :99 -screen 0 1920x1080x24 -ac +extension GLX +render -noreset > /dev/null 2>&1 &
          sleep 2
          echo "‚úÖ Virtual display started on :99"
      
      - name: Install Python Dependencies
        run: |
          echo "üì¶ Installing Python packages..."
          python -m pip install --upgrade pip
          pip install selenium==4.15.0 webdriver-manager==4.0.1 requests==2.31.0
          echo "‚úÖ Python dependencies installed"
      
      - name: Calculate Random Visit Count
        id: visit_count
        run: |
          # Generate random number between MIN and MAX
          RANDOM_VISITS=$(shuf -i $MIN_VISITS-$MAX_VISITS -n 1)
          echo "visits=$RANDOM_VISITS" >> $GITHUB_OUTPUT
          
          # Calculate estimated duration (avg 1.5 min per visit)
          ESTIMATED_MINUTES=$((RANDOM_VISITS * 90 / 60))
          
          echo ""
          echo "=========================================="
          echo "üé≤ RANDOMIZED DAILY PLAN"
          echo "=========================================="
          echo "Target visitors today: $RANDOM_VISITS"
          echo "Estimated duration: ~$ESTIMATED_MINUTES minutes"
          echo "Start time: $(date -u)"
          echo "=========================================="
          echo ""
      
      - name: Run Fraud Detection Tests
        env:
          DAILY_VISITS: ${{ steps.visit_count.outputs.visits }}
          DISPLAY: :99
        run: |
          echo "üöÄ Starting fraud detection test suite..."
          echo "Target: $DAILY_VISITS visitors"
          echo ""
          
          # Run the main script
          python fraud_detection_tester.py || echo "Script completed with errors (may be normal)"
          
          echo ""
          echo "‚úÖ Test suite execution finished!"
      
      - name: Parse Results
        if: always()
        id: results
        run: |
          if [ -f fraud_detection_test.log ]; then
            # Extract successful and failed visits from log
            SUCCESSFUL=$(grep "‚úÖ Visit successful:" fraud_detection_test.log | wc -l)
            FAILED=$(grep "‚ùå Visit failed:" fraud_detection_test.log | wc -l)
            
            # Extract total impressions from the session report
            TOTAL_IMP=$(grep "üî• Total Impressions:" fraud_detection_test.log | tail -1 | grep -oP '\d+$' || echo 0)
            
            # Ensure values are set
            SUCCESSFUL=${SUCCESSFUL:-0}
            FAILED=${FAILED:-0}
            TOTAL_IMP=${TOTAL_IMP:-0}
            
            # Output to GitHub Actions
            echo "successful=$SUCCESSFUL" >> $GITHUB_OUTPUT
            echo "failed=$FAILED" >> $GITHUB_OUTPUT
            echo "total_impressions=$TOTAL_IMP" >> $GITHUB_OUTPUT
            
            # Display results
            echo ""
            echo "=========================================="
            echo "üéØ ADSTERRA IMPRESSION RESULTS"
            echo "=========================================="
            echo "‚úÖ Successful visits: $SUCCESSFUL"
            echo "‚ùå Failed visits: $FAILED"
            echo "üìä Total Impressions Generated: $TOTAL_IMP"
            
            if [ "$SUCCESSFUL" -gt 0 ]; then
              AVG=$((TOTAL_IMP / SUCCESSFUL))
              echo "üìà Avg Impressions/Visit: $AVG"
            fi
            echo "=========================================="
          else
            echo "‚ö†Ô∏è No log file found"
            echo "successful=0" >> $GITHUB_OUTPUT
            echo "failed=0" >> $GITHUB_OUTPUT
            echo "total_impressions=0" >> $GITHUB_OUTPUT
          fi
      
      - name: Upload Complete Logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: fraud-test-logs-${{ github.run_number }}-${{ steps.visit_count.outputs.visits }}visitors
          path: |
            fraud_detection_test.log
          retention-days: 30
          compression-level: 9
          if-no-files-found: warn
      
      - name: Generate Summary Report
        if: always()
        run: |
          echo "# üéØ ADSTERRA IMPRESSION REPORT" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Date:** $(date -u +"%Y-%m-%d %H:%M UTC")" >> $GITHUB_STEP_SUMMARY
          echo "**Run Number:** #${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "## üìà Today's Results" >> $GITHUB_STEP_SUMMARY
          PLANNED_VISITS="${{ steps.visit_count.outputs.visits }}"
          PLANNED_VISITS=${PLANNED_VISITS:-0}
          echo "- **Planned visitors:** $PLANNED_VISITS" >> $GITHUB_STEP_SUMMARY
          
          SUCCESSFUL="${{ steps.results.outputs.successful }}"
          FAILED="${{ steps.results.outputs.failed }}"
          TOTAL_IMP="${{ steps.results.outputs.total_impressions }}"
          
          # Set defaults if empty
          SUCCESSFUL=${SUCCESSFUL:-0}
          FAILED=${FAILED:-0}
          TOTAL_IMP=${TOTAL_IMP:-0}
          
          echo "- **Successful visits:** $SUCCESSFUL" >> $GITHUB_STEP_SUMMARY
          echo "- **Failed visits:** $FAILED" >> $GITHUB_STEP_SUMMARY
          echo "- **üî• Total Impressions Generated:** $TOTAL_IMP" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Calculate success rate and avg impressions
          TOTAL=$((SUCCESSFUL + FAILED))
          
          if [ "$TOTAL" -gt 0 ]; then
            SUCCESS_RATE=$((SUCCESSFUL * 100 / TOTAL))
            if [ "$SUCCESSFUL" -gt 0 ]; then
              AVG_IMP=$((TOTAL_IMP / SUCCESSFUL))
              echo "- **Success rate:** ${SUCCESS_RATE}%" >> $GITHUB_STEP_SUMMARY
              echo "- **üìä Avg Impressions/Visit:** ${AVG_IMP}" >> $GITHUB_STEP_SUMMARY
            fi
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## üéØ Key Metrics" >> $GITHUB_STEP_SUMMARY
          echo "- **Real Adsterra impressions:** Generated through natural page interactions" >> $GITHUB_STEP_SUMMARY
          echo "- **Ad element detection:** Finds and interacts with actual ad elements" >> $GITHUB_STEP_SUMMARY
          echo "- **Viewport interactions:** Triggers responsive ad impressions" >> $GITHUB_STEP_SUMMARY
          echo "- **Natural scrolling:** Preserves human-like randomness" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## üìä Log Summary" >> $GITHUB_STEP_SUMMARY
          
          if [ -f fraud_detection_test.log ]; then
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            tail -n 30 fraud_detection_test.log >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "*Next run scheduled for tomorrow at 2 AM UTC* ‚è∞" >> $GITHUB_STEP_SUMMARY
      
      - name: Notify on Failure
        if: failure()
        run: |
          echo "‚ùå Workflow failed! Check logs for details."
          echo "This won't affect tomorrow's scheduled run."

  # Optional: Quick health check (runs every 6 hours)
  health-check:
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' && contains(github.event.schedule, '*/6')
    
    steps:
      - name: System Health Check
        run: |
          echo "üè• Running health check..."
          echo "GitHub Actions status: OK"
          echo "Next full test: Check scheduled runs"
