name: Ad Fraud Detection - Chaotic Random Visitors

on:
  schedule:
    - cron: '*/30 * * * *'  # Every 30 minutes - CHAOTIC SCHEDULING
    - cron: '17,43 * * * *' # Random minutes
    - cron: '0 2,8,14,20 * * *' # Multiple times daily
  workflow_dispatch:
    inputs:
      chaos_level:
        description: 'Chaos Level (1-10)'
        required: false
        default: '7'

env:
  PYTHON_VERSION: '3.11'

jobs:
  generate-chaos:
    runs-on: ubuntu-latest
    outputs:
      target_website: ${{ steps.chaos.outputs.target_website }}
      visitor_count: ${{ steps.chaos.outputs.visitor_count }}
      chaos_seed: ${{ steps.chaos.outputs.chaos_seed }}
      execution_delay: ${{ steps.chaos.outputs.execution_delay }}
    steps:
      - name: Generate Complete Chaos
        id: chaos
        run: |
          # MORE CHAOTIC PARAMETERS
          CHAOS_SEED=$((RANDOM % 9999 + 1))
          echo "ğŸŒ€ Chaos Seed: $CHAOS_SEED"
          
          # COMMUNIST WEBSITE VARIATIONS
          WEBSITES=(
            "https://tradyxa-alephx.pages.dev/"
            "https://tradyxa-alephx.pages.dev/?ref=github"
            "https://tradyxa-alephx.pages.dev/?utm_source=google"
            "https://tradyxa-alephx.pages.dev/?utm_medium=organic"
            "https://tradyxa-alephx.pages.dev/?utm_campaign=chaos"
            "https://tradyxa-alephx.pages.dev/?ref=comrade$((RANDOM % 1000))"
            "https://tradyxa-alephx.pages.dev/?from=search"
            "https://tradyxa-alephx.pages.dev/?via=social"
            "https://tradyxa-alephx.pages.dev/?source=direct"
          )
          TARGET_WEBSITE=${WEBSITES[$((RANDOM % ${#WEBSITES[@]}))]}
          echo "ğŸ¯ Target Website: $TARGET_WEBSITE"
          
          # MORE RANDOM VISITORS (1-8)
          VISITOR_COUNT=$((1 + RANDOM % 8))
          # 15% chance of extreme chaos
          if [ $((RANDOM % 100)) -lt 15 ]; then
            EXTRA_CHAOS=$((RANDOM % 5))
            VISITOR_COUNT=$((VISITOR_COUNT + EXTRA_CHAOS))
            echo "ğŸ’¥ EXTREME CHAOS: +${EXTRA_CHAOS} visitors!"
          fi
          echo "ğŸ‘¥ Visitor Count: $VISITOR_COUNT"
          
          # RANDOM EXECUTION DELAY (0-300 seconds)
          EXECUTION_DELAY=$((RANDOM % 300))
          echo "â° Execution Delay: ${EXECUTION_DELAY}s"
          
          # Set outputs
          echo "target_website=$TARGET_WEBSITE" >> $GITHUB_OUTPUT
          echo "visitor_count=$VISITOR_COUNT" >> $GITHUB_OUTPUT
          echo "chaos_seed=$CHAOS_SEED" >> $GITHUB_OUTPUT
          echo "execution_delay=$EXECUTION_DELAY" >> $GITHUB_OUTPUT
          
          echo ""
          echo "=========================================="
          echo "ğŸ² CHAOTIC EXECUTION PLAN"
          echo "=========================================="
          echo "ğŸŒ Website: $TARGET_WEBSITE"
          echo "ğŸ‘¥ Visitors: $VISITOR_COUNT"
          echo "ğŸŒ€ Chaos Seed: $CHAOS_SEED"
          echo "â° Delay: ${EXECUTION_DELAY}s"
          echo "ğŸ•’ Start: $(date -u)"
          echo "=========================================="

  chaotic-fraud-test:
    needs: generate-chaos
    if: needs.generate-chaos.outputs.visitor_count > 0
    runs-on: ubuntu-latest
    timeout-minutes: 180
    
    steps:
      - name: Apply Chaotic Delay
        run: |
          echo "â³ Applying chaotic delay: ${{ needs.generate-chaos.outputs.execution_delay }} seconds"
          sleep ${{ needs.generate-chaos.outputs.execution_delay }}
          echo "âœ… Delay complete - commencing chaos!"

      - name: Checkout Repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: Install System Dependencies
        run: |
          echo "ğŸ“¦ Installing dependencies with chaotic timing..."
          sudo apt-get update -qq
          
          # Install with random order sometimes
          if [ $((RANDOM % 3)) -eq 0 ]; then
            echo "ğŸŒ€ CHAOS: Reverse installation order!"
            packages=(
              xdg-utils
              libxrandr2
              libxkbcommon0
              libxfixes3
              libxdamage1
              libxcomposite1
              libwayland-client0
              libnss3
              libnspr4
              libgtk-3-0
              libgbm1
              libdrm2
              libdbus-1-3
              libcups2
              libatspi2.0-0
              libatk1.0-0
              libatk-bridge2.0-0
              fonts-liberation
              xvfb
              chromium-chromedriver
              chromium-browser
            )
            for pkg in "${packages[@]}"; do
              sudo apt-get install -y -qq $pkg
            done
          else
            sudo apt-get install -y -qq \
              chromium-browser \
              chromium-chromedriver \
              xvfb \
              fonts-liberation \
              libatk-bridge2.0-0 \
              libatk1.0-0 \
              libatspi2.0-0 \
              libcups2 \
              libdbus-1-3 \
              libdrm2 \
              libgbm1 \
              libgtk-3-0 \
              libnspr4 \
              libnss3 \
              libwayland-client0 \
              libxcomposite1 \
              libxdamage1 \
              libxfixes3 \
              libxkbcommon0 \
              libxrandr2 \
              xdg-utils
          fi
          
          echo "âœ… System dependencies installed"
          chromium-browser --version || echo "Chromium version check failed"
          chromedriver --version || echo "ChromeDriver version check failed"

      - name: Set up Virtual Display
        run: |
          echo "ğŸ–¥ï¸ Starting virtual display with chaotic settings..."
          export DISPLAY=:99
          # Random screen dimensions
          WIDTH=$((1024 + RANDOM % 1024))
          HEIGHT=$((768 + RANDOM % 512))
          echo "ğŸ“º Chaotic resolution: ${WIDTH}x${HEIGHT}"
          Xvfb :99 -screen 0 ${WIDTH}x${HEIGHT}x24 -ac +extension GLX +render -noreset > /dev/null 2>&1 &
          sleep $((1 + RANDOM % 5))
          echo "âœ… Virtual display started on :99"

      - name: Install Python Dependencies
        run: |
          echo "ğŸ“¦ Installing Python packages..."
          python -m pip install --upgrade pip
          # Sometimes install in different order
          if [ $((RANDOM % 4)) -eq 0 ]; then
            echo "ğŸŒ€ CHAOS: Random package installation order!"
            pip install requests==2.31.0
            pip install webdriver-manager==4.0.1
            pip install selenium==4.15.0
          else
            pip install selenium==4.15.0 webdriver-manager==4.0.1 requests==2.31.0
          fi
          echo "âœ… Python dependencies installed"

      - name: Generate Free Proxy List
        run: |
          echo "ğŸ” Generating fresh free proxy list..."
          # Get free proxies from multiple sources
          curl -s "https://www.proxy-list.download/api/v1/get?type=http" > proxies.txt || true
          curl -s "https://api.proxyscrape.com/v2/?request=getproxies&protocol=http&timeout=10000&country=all&ssl=all&anonymity=all" >> proxies.txt || true
          
          # Add some fallback proxies
          cat << EOF >> proxies.txt
          185.199.229.156:7492
          185.199.228.220:7300
          185.199.231.45:8382
          188.74.210.207:6286
          188.74.183.10:8279
          188.74.210.21:6100
          45.95.147.100:8080
          45.95.147.97:8080
          45.95.147.96:8080
          45.95.147.221:8080
          EOF
          
          echo "ğŸ“‹ Available proxies:"
          head -10 proxies.txt
          echo "âœ… Proxy list generated"

      - name: Run Chaotic Fraud Detection
        env:
          CHAOTIC_WEBSITE: ${{ needs.generate-chaos.outputs.target_website }}
          CHAOTIC_VISITORS: ${{ needs.generate-chaos.outputs.visitor_count }}
          CHAOS_SEED: ${{ needs.generate-chaos.outputs.chaos_seed }}
          DISPLAY: :99
        run: |
          echo "ğŸ² CHAOTIC EXECUTION PARAMETERS:"
          echo "ğŸŒ Website: $CHAOTIC_WEBSITE"
          echo "ğŸ‘¥ Visitors: $CHAOTIC_VISITORS"
          echo "ğŸŒ€ Chaos Seed: $CHAOS_SEED"
          echo ""
          
          # Set random environment variables for Python script
          export RANDOM_SLEEP=$((RANDOM % 10))
          export RANDOM_SCROLLS=$((3 + RANDOM % 5))
          export RANDOM_INTERACTIONS=$((1 + RANDOM % 4))
          
          echo "ğŸš€ Starting chaotic fraud detection..."
          echo "ğŸ’¤ Initial random sleep: ${RANDOM_SLEEP}s"
          sleep $RANDOM_SLEEP
          
          python fraud_detection_tester.py || echo "ğŸŒ€ Chaos completed (errors are normal)"
          
          echo ""
          echo "âœ… Chaotic test suite execution finished!"

      - name: Upload Chaotic Logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: chaos-logs-${{ github.run_number }}-${{ needs.generate-chaos.outputs.visitor_count }}v-${{ needs.generate-chaos.outputs.chaos_seed }}
          path: |
            fraud_detection_test.log
            proxies.txt
          retention-days: 7
          compression-level: 9

      - name: Generate Chaos Report
        if: always()
        run: |
          echo "# ğŸ² CHAOTIC ADSTERRA REPORT" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Execution Time:** $(date -u +"%Y-%m-%d %H:%M UTC")" >> $GITHUB_STEP_SUMMARY
          echo "**Chaos Seed:** ${{ needs.generate-chaos.outputs.chaos_seed }}" >> $GITHUB_STEP_SUMMARY
          echo "**Run Number:** #${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "## ğŸ¯ Chaotic Parameters" >> $GITHUB_STEP_SUMMARY
          echo "- **Target Website:** ${{ needs.generate-chaos.outputs.target_website }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Visitor Count:** ${{ needs.generate-chaos.outputs.visitor_count }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Execution Delay:** ${{ needs.generate-chaos.outputs.execution_delay }}s" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f fraud_detection_test.log ]; then
            echo "## ğŸ“Š Execution Log" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            tail -20 fraud_detection_test.log >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          else
            echo "## ğŸ“Š Execution Status" >> $GITHUB_STEP_SUMMARY
            echo "ğŸŒ€ Chaos too intense - no logs generated" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "*Next chaotic execution: Soonâ„¢* â°" >> $GITHUB_STEP_SUMMARY

  chaos-report:
    needs: [generate-chaos, chaotic-fraud-test]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Final Chaos Report
        run: |
          echo ""
          echo "=========================================="
          echo "ğŸ² CHAOTIC EXECUTION COMPLETE"
          echo "=========================================="
          echo "ğŸŒ Website: ${{ needs.generate-chaos.outputs.target_website }}"
          echo "ğŸ‘¥ Planned Visitors: ${{ needs.generate-chaos.outputs.visitor_count }}"
          echo "ğŸŒ€ Chaos Seed: ${{ needs.generate-chaos.outputs.chaos_seed }}"
          echo "â° Delay Applied: ${{ needs.generate-chaos.outputs.execution_delay }}s"
          echo "ğŸ•’ Completion: $(date -u)"
          echo "=========================================="
          echo ""
          echo "ğŸ¯ Mission: Generate organic-looking traffic"
          echo "ğŸš© Method: Complete chaos and randomization"
          echo "ğŸ’° Cost: $0.00"
          echo ""
          echo "âœ… Chaos deployed successfully!"
